---
import wizardUrl from '../../scripts/wizard.js?url';
import DocLayout from '../../layouts/DocLayout.astro';
import nav from '../../data/nav.json';
import wizard from '../../data/wizard-matrix.json';

const frontmatter = {
  title: "Privacy‑Plan‑Assistent",
  description: "Beantworte 4 kurze Fragen und erhalte einen klaren Plan (Weg A/B/C) mit Links in der richtigen Reihenfolge.",
  robots: "index,follow",
  search: "no",
  updated: "2026-01-14",
  chapter: "Start",
  type: "single",
  format: "F4",
  level: "Basis",
  money: "no",
  status: "done",
  url: "/wizard/",
};

// Derive chapter roots from the first item per column (same logic as Base.astro)
const segFromHref = (href) => (String(href || '/').split('/').filter(Boolean)[0] || '');
const chapterRootForCol = (col) => {
  const seg = segFromHref(col?.items?.[0]?.href ?? '/');
  return seg ? `/${seg}/` : '/';
};

const chapters = (nav.chapters ?? []).map((col) => ({
  title: col.title,
  href: chapterRootForCol(col),
  items: col.items ?? [],
}));

// Quick lookup: href -> {label, chapterTitle}
const hrefIndex = new Map();
for (const ch of chapters) {
  for (const it of ch.items) hrefIndex.set(it.href, { label: it.label, chapter: ch.title });
}
function labelFor(href){
  return hrefIndex.get(href)?.label ?? href;
}
function chapterFor(href){
  return hrefIndex.get(href)?.chapter ?? '';
}
---

<DocLayout {...frontmatter}>
  <div class="callout subtle">
    <p><strong>Was ist das?</strong> Ein kurzer Assistent, der dir aus den Kapiteln einen Plan baut. Du bekommst Links in Reihenfolge — und eine Empfehlung, ob du auf der Zielseite <em>Weg A</em>, <em>B</em> oder <em>C</em> folgen solltest.</p>
  </div>

  <noscript>
    <div class="callout">
      <p><strong>Hinweis:</strong> Der Assistent benötigt JavaScript. Ohne JavaScript kannst du so starten:</p>
      <ul>
        <li><a href="/start/schnellstart/">Start: Schnellstart</a> (10 Minuten)</li>
        <li><a href="/privacy-check/level-1/">Privacy Check Level 1</a> (Basis)</li>
        <li><a href="/verzeichnis/">Verzeichnis</a> (alle Themen)</li>
      </ul>
    </div>
  </noscript>

  <div class="wizard js-only" id="pbWizard" aria-label="Privacy‑Plan‑Assistent">
    <div class="wizard-progress" aria-label="Fortschritt">
      <progress id="wizProg" class="wizard-progress-bar" max="100" value="0" aria-hidden="true"></progress>
      <div class="wizard-progress-steps">
        <span class="wizard-progress-step active" data-stepdot="0">Setup</span>
        <span class="wizard-progress-step" data-stepdot="1">Ziele</span>
        <span class="wizard-progress-step" data-stepdot="2">Tiefe</span>
        <span class="wizard-progress-step" data-stepdot="3">Zeit</span>
        <span class="wizard-progress-step" data-stepdot="4">Plan</span>
      </div>
    </div>

    <form class="wizard-form" id="wizForm">
      <!-- STEP 1 -->
      <section class="wizard-step" data-step="0">
        <h2>1) Welche Geräte nutzt du?</h2>
        <p class="muted">Mehrfachauswahl möglich. Wenn du unsicher bist: wähle einfach „Android“ oder „iOS“ (Smartphone) und „Windows“ oder „macOS“ (Desktop).</p>

        <div class="wizard-grid">
          <fieldset class="wizard-fieldset">
            <legend>Smartphone</legend>
            <label class="wizard-choice"><input type="checkbox" name="device" value="android"> <span><strong>Android</strong><span class="small muted"> (Einstellungen, Werbe‑ID, Push‑IDs)</span></span></label>
            <label class="wizard-choice"><input type="checkbox" name="device" value="ios"> <span><strong>iPhone/iOS</strong><span class="small muted"> (Einstellungen, Push‑IDs, Standort)</span></span></label>
          </fieldset>

          <fieldset class="wizard-fieldset">
            <legend>Computer</legend>
            <label class="wizard-choice"><input type="checkbox" name="device" value="windows"> <span><strong>Windows</strong><span class="small muted"> (Privacy‑Basics, Updates, Verschlüsselung)</span></span></label>
            <label class="wizard-choice"><input type="checkbox" name="device" value="macos"> <span><strong>macOS</strong><span class="small muted"> (Privacy‑Basics, Updates, Verschlüsselung)</span></span></label>
            <label class="wizard-choice"><input type="checkbox" name="device" value="linux"> <span><strong>Linux</strong><span class="small muted"> (Basis + Altgeräte‑Wipe)</span></span></label>
            <label class="wizard-choice"><input type="checkbox" name="device" value="chromeos"> <span><strong>ChromeOS</strong><span class="small muted"> (Altgeräte‑Wipe + Updates)</span></span></label>
          </fieldset>
        </div>
      </section>

      <!-- STEP 2 -->
      <section class="wizard-step" data-step="1" hidden>
        <h2>2) Was ist dein Ziel?</h2>
        <p class="muted">Wähle 1–3 Themen. Wenn du „Schnelle Wirkung“ wählst, bekommst du automatisch die größten Hebel zuerst.</p>

        <div class="wizard-goals" id="wizGoals">
          {wizard.goals.map((g) => (
            <label class="wizard-goal">
              <input type="checkbox" name="goal" value={g.id} />
              <span class="wizard-goal-body">
                <span class="wizard-goal-title">{g.label}</span>
                <span class="wizard-goal-hint">{g.hint}</span>
              </span>
            </label>
          ))}
        </div>
        <p class="muted small">Tipp: Für einen allgemeinen Plan wähle nur <strong>Schnelle Wirkung</strong> — und ergänze später Spezialthemen.</p>
      </section>

      <!-- STEP 3 -->
      <section class="wizard-step" data-step="2" hidden>
        <h2>3) Wie weit willst du gehen?</h2>
        <p class="muted">Das steuert die Empfehlung, ob du auf jeder Seite Weg A, B oder C nutzen solltest.</p>

        <div class="wizard-levels">
          {wizard.riskLevels.map((l) => (
            <label class="wizard-radio">
              <input type="radio" name="risk" value={l.id} checked={l.id === 'A' ? true : undefined} />
              <span>
                <strong>{l.label}</strong>
                <span class="small muted">{l.hint}</span>
              </span>
            </label>
          ))}
        </div>

        <div class="callout subtle">
          <p><strong>Merksatz:</strong> Weg A = stabil & schnell · Weg B = datensparsam · Weg C = maximal (mehr Pflege). Du musst nicht „alles“ machen, um deutlich besser zu werden.</p>
        </div>
      </section>

      <!-- STEP 4 -->
      <section class="wizard-step" data-step="3" hidden>
        <h2>4) Wie viel Zeit hast du?</h2>
        <p class="muted">Der Assistent begrenzt die Anzahl der vorgeschlagenen Seiten. Du kannst danach jederzeit „mehr hinzufügen“.</p>

        <div class="wizard-times">
          {wizard.timeBudgets.map((t) => (
            <label class="wizard-radio">
              <input type="radio" name="time" value={t.id} checked={t.id === '30-60m' ? true : undefined} />
              <span><strong>{t.label}</strong><span class="small muted"> (max. {t.cap} Seiten)</span></span>
            </label>
          ))}
        </div>
      </section>

      <!-- RESULT -->
      <section class="wizard-step" data-step="4" hidden>
        <h2>Dein Plan</h2>
        <div class="wizard-summary" id="wizSummary"></div>

        <details class="callout subtle" id="wizPfadeExplain" open>
          <summary><strong>Du bist bei Weg A</strong> – wofür ist das?</summary>
          <div class="pb-editorial-body">
            <p class="muted">Der Pfad sagt dir, wie tief du pro Thema gehen sollst. Du musst nicht alles machen: schon Weg A bringt die größten Hebel.</p>
            <ul>
              <li><strong>Weg A:</strong> schnell, alltagstauglich, wenig Pflege.</li>
              <li><strong>Weg B:</strong> datensparsam, etwas mehr Aufwand, weniger Nebeninformationen.</li>
              <li><strong>Weg C:</strong> für hohes Risiko: starke Härtung, deutlich mehr Aufwand und mögliche Einschränkungen.</li>
            </ul>
            <p class="muted small">Tipp: Wenn du bei einem Thema festhängst, bleib dort erst bei Weg A und teste danach. Später kannst du B/C nachziehen.</p>
          </div>
        </details>

        <div class="wizard-checklist-meta" aria-label="Personalisierte Checkliste">
          <div class="wizard-checklist-top">
            <p class="muted small" id="wizProgressText"></p>
            <progress id="wizDoneProg" class="wizard-mini-bar" max="100" value="0" aria-hidden="true"></progress>
          </div>
          <div class="wizard-checklist-actions">
            <button class="btn" id="wizMarkAll" type="button">Alles abhaken</button>
            <button class="btn" id="wizClearChecks" type="button">Zurücksetzen</button>
            <button class="btn" id="wizPrint" type="button">Drucken</button>
          </div>
          <p class="muted small">Die Häkchen werden nicht gespeichert (keine Cookies, kein lokaler Speicher im Browser (Local Storage)).</p>
        </div>

        <ol class="wizard-plan" id="wizPlan" aria-label="Empfohlene Reihenfolge"></ol>

        <details class="callout pb-editorial" id="wizProfiBox">
          <summary><strong>Profi‑Ergänzungen</strong> (wenn du Weg C gewählt hast)</summary>
          <div class="pb-editorial-body">
            <p class="muted">Das sind harte Hebel, die oft extra Aufwand bedeuten. Nimm sie nur, wenn du den Bedarf wirklich hast.</p>
            <ul>
              {wizard.profiAddons.map((href) => (
                <li><a href={href}>{chapterFor(href) ? `${chapterFor(href)} / ` : ''}{labelFor(href)}</a></li>
              ))}
            </ul>
          </div>
        </details>

        <details class="callout" open>
          <summary><strong>Alle Kapitel</strong> (zum Stöbern / Ergänzen)</summary>
          <div class="pb-editorial-body">
            <p class="muted">Alles auf einer Seite: <a href="/verzeichnis/">Verzeichnis</a>. Oder hier direkt nach Kapiteln:</p>
            {chapters.map((ch) => (
              <details class="wizard-chapter" data-chapter={ch.title}>
                <summary><strong>{ch.title}</strong> <span class="muted small">({ch.items.length} Themen)</span></summary>
                <ul class="wizard-links">
                  <li class="muted small"><a href={ch.href}>Übersicht</a></li>
                  {ch.items.map((it) => (
                    <li><a data-href={it.href} href={it.href}>{it.label}</a></li>
                  ))}
                </ul>
              </details>
            ))}
          </div>
        </details>
      </section>

      <div class="wizard-nav">
        <button class="btn" id="wizBack" type="button">Zurück</button>
        <button class="btn" id="wizNext" type="button">Weiter</button>
        <button class="btn wizard-reset" id="wizReset" type="button" hidden>Neu starten</button>
      </div>
    </form>
  </div>


  <section class="pb-editorial-body">
    <h2>So nutzt du den Assistenten</h2>
    <p>Du beantwortest 4 kurze Fragen und bekommst danach eine Reihenfolge mit direkten Links. Auf jeder Zielseite steht dabei, ob du dort <em>Weg A</em> (schnell), <em>Weg B</em> (datensparsam) oder <em>Weg C</em> (maximal) folgen solltest.</p>
    <p>Wenn du lieber ohne Assistent startest: <a href="/start/schnellstart/">Start: Schnellstart</a>, <a href="/start/empfehlungen-nach-level/">Empfehlungen nach Level</a> oder der <a href="/privacy-check/level-1/">Privacy Check</a> geben dir ebenfalls eine klare Reihenfolge.</p>
  </section>

  <template id="wizConfig" data-json set:html={JSON.stringify(wizard)}></template>
  <template id="wizNav" data-json set:html={JSON.stringify(chapters)}></template>

  <script type="module" src={wizardUrl}></script>
</DocLayout>