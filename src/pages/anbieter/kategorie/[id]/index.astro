---
import DocLayout from '../../../../layouts/DocLayout.astro';
import taxonomy from '../../../../data/anbieter-taxonomy.json';

// Load all provider pages (each is /anbieter/<slug>/index.md)
const providerPages = Object.values(import.meta.glob('../../*/index.md', { eager: true }));

// Helpers
const norm = (v) => String(v ?? '').trim();
const normKey = (v) => norm(v).toLowerCase();

const aliases = taxonomy?.aliases ?? {};
const categories = taxonomy?.categories ?? [];

const labelById = new Map(categories.map((c) => [c.id, c.label]));
const idByLabel = new Map(categories.map((c) => [normKey(c.label), c.id]));

function resolveCategoryId(rawCategory) {
  const raw = norm(rawCategory);
  const aliased = aliases[raw] ?? raw;
  const key = normKey(aliased);
  // allow passing ids directly
  if (labelById.has(key)) return key;
  if (labelById.has(raw)) return raw;
  return idByLabel.get(key) ?? null;
}

function catIntro(id) {
  // Keep this neutral: criteria first, then a short curated list.
  // You can later replace these with category-specific markdown.
  const label = labelById.get(id) ?? id;
  const base = `Hier findest du **Kriterien** zum Vergleichen und eine **kuratierte Shortlist**.\n\nWichtig: Empfehlungen hängen von deinem Bedrohungsmodell ab. Wenn du unsicher bist, starte mit **Privacy-Check Level 1**.`;

  const extras = {
    passwortmanager:
      'Achte besonders auf: **starkes Master-Passwort/Passphrase**, **sichere Synchronisation**, **Notfallzugang**, **Plattform-Support**, **Audit/Transparenz**.',
    '2fa':
      'Achte besonders auf: **Export/Backup von Tokens**, **Gerätewechsel**, **Offline-Fähigkeit**, **Open Source**, **Sperre/Biometrie**.',
    'security-key':
      'Achte besonders auf: **FIDO2/WebAuthn**, **Passkey-Support**, **Backup-Key-Strategie**, **PIN/Touch**, **Kompatibilität**.',
    backup:
      'Achte besonders auf: **Versionierung**, **Restore-Test**, **Verschlüsselung**, **3-2-1 Strategie**, **Automatisierung**.',
    vpn:
      'Achte besonders auf: **Protokoll (WireGuard/OpenVPN)**, **Kill Switch**, **Leak-Schutz**, **Transparenz/Logs**, **Multi-Device**. VPN ist kein Allheilmittel.',
    dns:
      'Achte besonders auf: **DoH/DoT**, **Logging/Retention**, **Resolver-Standort**, **Filter optional**, **Kompatibilität**.',
    'e-mail':
      'Achte besonders auf: **IMAP/SMTP**, **2FA**, **Login-Sicherheit**, **Anti-Tracking**, **Recovery-Prozess**.',
    'e-mail-aliasing':
      'Achte besonders auf: **Domain-Support**, **Catch-all/Regex**, **Weiterleitung/Reply**, **Export**, **Transparenz**.',
    'cloud-and-sync':
      'Achte besonders auf: **E2EE wirklich** (wer hat Schlüssel?), **Sharing-Links**, **Recovery**, **Clients/Plattformen**, **Transparenz**.',
  };

  return `${base}\n\n${extras[id] ?? ''}`.trim();
}

function catCriteria(id) {
  // Short, action-oriented criteria lists for skimming & SEO snippets.
  const criteria = {
    passwortmanager: [
      'Notfall & Wiederherstellung (Recovery, Notfallkontakt)',
      'Sync-Modell & Sicherheit (E2EE, Clients, Schlüssel)',
      'Plattformen (Windows/macOS/iOS/Android/Linux) + Browser',
      'Audit/Transparenz + Update-Frequenz',
      'Auto-Fill Kontrolle + Phishing-Schutz',
    ],
    '2fa': [
      'Backup/Export von Tokens (ohne Stress bei Gerätewechsel)',
      'Offline-Nutzung + Sperre/Biometrie',
      'Open Source + Reviewbarkeit',
      'Mehrgeräte-Setup + Recovery-Strategie',
    ],
    'security-key': [
      'FIDO2/WebAuthn Kompatibilität (auch Passkeys)',
      'Backup-Key-Strategie (mind. 2 Keys)',
      'PIN/Touch/Policy (Schutz bei Diebstahl)',
      'USB-A/C, NFC, Lightning je nach Geräten',
    ],
    backup: [
      '3-2-1 Umsetzbarkeit (lokal + offsite)',
      'Verschlüsselung (vor Upload / at rest)',
      'Versionierung + Restore-Tests',
      'Automatisierung + Benachrichtigung bei Fehlern',
    ],
    vpn: [
      'Leak-Schutz (DNS/WebRTC/IPV6) + Kill Switch',
      'Protokolle (WireGuard/OpenVPN) + Multi-Hop optional',
      'Transparenz (Logs/Retention/Ownership)',
      'Usability (Router/Clients, Captive Portal)',
    ],
    dns: [
      'DoH/DoT Support + Fallback-Verhalten',
      'Logging/Retention (klar dokumentiert)',
      'Standort/Region + Rechtliches Umfeld',
      'Filter optional (Ads/Malware/Family) ohne Zwang',
    ],
    'e-mail': [
      'Login-Sicherheit (2FA, Passkeys) + Recovery',
      'Anti-Tracking (remote Bilder, Pixel-Block, Link-Preview)',
      'IMAP/SMTP + Clients + Spam-Schutz',
      'Transparenz (Data Handling, Policies)',
    ],
    'e-mail-aliasing': [
      'Aliasing-Modell (Catch-all, Random, Regex)',
      'Reply/Compose Support (Antworten über Alias)',
      'Export/Portabilität',
      'Domain-Support + Weiterleitungskontrolle',
    ],
    'cloud-and-sync': [
      'E2EE: Wer hat die Schlüssel? (Realität vs Marketing)',
      'Sharing-Links & Rechte (Download/Expiry/Passwort)',
      'Clients/Plattformen + Offline-Zugriff',
      'Recovery/Account-Sicherheit',
    ],
  };
  return criteria[id] ?? [];
}

export async function getStaticPaths() {
  return (taxonomy?.categories ?? []).map((c) => ({ params: { id: c.id } }));
}

const { id } = Astro.params;
const label = labelById.get(id) ?? id;

// Filter providers by resolved category id
const providers = providerPages
  .map((p) => {
    const fm = p.frontmatter ?? {};
    const prov = fm.provider ?? {};
    const rawCat = prov.category ?? '';
    const cid = resolveCategoryId(rawCat);
    return {
      title: fm.title ?? prov.name ?? 'Unbenannt',
      url: fm.url ?? '',
      categoryId: cid,
      price: prov.price ?? '',
      oss: prov.openSource ?? prov.oss ?? '',
      e2ee: prov.e2ee ?? '',
      region: prov.region ?? '',
      notes: prov.note ?? prov.notes ?? '',
      updated: fm.updated ?? '',
      status: fm.status ?? '',
    };
  })
  .filter((x) => x.url && x.categoryId === id)
  .sort((a, b) => String(a.title).localeCompare(String(b.title), 'de'));

const frontmatter = {
  title: `${label}: Kriterien & Empfehlungen`,
  description: `Vergleiche ${label}: Kriterien, Shortlist und Links zu Anbieter-Profilen. Neutral erklärt – mit Transparenz zu Affiliate-Links auf Anbieter-Seiten.`,
  robots: 'index,follow',
  updated: '2026-02-10',
  chapter: 'Anbieter',
  type: 'guide',
  format: 'directory',
  level: '',
  money: 'maybe',
  status: 'done',
  url: `/anbieter/kategorie/${id}/`,
};

const criteria = catCriteria(id);
const intro = catIntro(id);
---

<DocLayout frontmatter={frontmatter}>
  <p>
    <strong>{label}</strong>
  </p>

  {intro.split('\n').map((line) => (line.trim() ? <p>{line}</p> : null))}

  {criteria.length > 0 ? (
    <>
      <h2>Kriterien (Kurzcheck)</h2>
      <ul>
        {criteria.map((c) => (
          <li>{c}</li>
        ))}
      </ul>
    </>
  ) : null}

  <h2>Shortlist</h2>
  {providers.length === 0 ? (
    <p>
      Für diese Kategorie sind noch keine Anbieter-Profile hinterlegt. Schau später nochmal rein oder nutze das
      <a href="/anbieter/"> Anbieter-Verzeichnis</a>.
    </p>
  ) : (
    <ul>
      {providers.map((p) => (
        <li>
          <a href={p.url}>{p.title}</a>
          {p.notes ? <span> — {p.notes}</span> : null}
        </li>
      ))}
    </ul>
  )}

  <h2>Transparenz</h2>
  <p>
    Auf den einzelnen Anbieter-Seiten können Affiliate-Links vorkommen. Diese Kategorie-Seite verlinkt nur intern auf
    Anbieter-Profile.
  </p>
</DocLayout>
