---
import Base from './Base.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import EeatBox from '../components/EeatBox.astro';
import site from '../data/site.json';
import nav from '../data/nav.json';
import { makeBreadcrumbs } from '../lib/breadcrumbs';
import { breadcrumbJsonLd, pageJsonLd } from '../lib/schema';

const fm = Astro.props.frontmatter ?? Astro.props;

const {
  title = site.siteName,
  description = site.defaultDescription,
  robots = 'index,follow',
  ogImage = site.defaultOgImage,
  canonical = null,
  updated = null,
  chapter = null,
  level = null,
} = fm;

const statusRaw = fm.status ?? null;
const status = String(statusRaw || '').trim().toLowerCase();
const isDone = !status || status === 'done';
const robotsFinal = isDone ? robots : 'noindex,follow';

const canonicalUrl = canonical
  ? canonical
  : (Astro.site
      ? new URL(Astro.url.pathname, Astro.site).toString()
      : new URL(Astro.url.pathname, site.baseUrl).toString());
const canonicalUrlNorm = canonicalUrl.endsWith('/') ? canonicalUrl : `${canonicalUrl}/`;

const crumbs = makeBreadcrumbs({
  pathname: Astro.url?.pathname || '/',
  title,
  nav,
  homeLabel: 'Start',
  homeHref: '/start/',
});

const structuredData = isDone ? [
  breadcrumbJsonLd(crumbs),
  pageJsonLd({
    schemaType: 'CollectionPage',
    title,
    description,
    url: canonicalUrlNorm,
    updated,
    ogImage,
  }),
] : null;


---

<Base
  title={title}
  description={description}
  robots={robotsFinal}
  ogType={'website'}
  ogImage={ogImage}
  updated={updated}
  canonical={canonical}
  structuredData={structuredData}
>
  <div class="container content">
    <header class="page-hero">
      <Breadcrumbs title={title} />
      <h1 class="page-title">{title}</h1>
      {description ? <p class="page-sub">{description}</p> : null}

      <div class="page-meta">
        {updated ? (<span>Zuletzt aktualisiert: {updated}</span>) : (<span>Zuletzt aktualisiert: Unbekannt</span>)}
        {chapter ? (<><span class="dot">•</span><span>{chapter}</span></>) : null}
        {(level && String(level).toLowerCase() !== 'none') ? (<><span class="dot">•</span><span>{level}</span></>) : null}
      </div>
    </header>

    <article class="article">
      {isDone ? (
        <div class="article-body markdown">
          <slot />
        </div>
      ) : (
        <div class="article-body markdown">
          <div class="callout">
            <p><strong>Hinweis:</strong> Diese Seite ist derzeit <strong>{status === 'archived' ? 'archiviert' : 'in Arbeit'}</strong> und wird bewusst nicht indexiert.</p>
          </div>
        </div>
      )}

      {isDone ? (
        <EeatBox
          updated={updated}
          isAnbieter={false}
          scope={chapter ? `Kapitel: ${chapter}` : null}
        />
      ) : null}
    </article>
  </div>
</Base>
