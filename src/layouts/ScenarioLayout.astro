---
import Base from './Base.astro';
import Breadcrumbs from '../components/Breadcrumbs.astro';
import EeatBox from '../components/EeatBox.astro';
import site from '../data/site.json';
import nav from '../data/nav.json';
import { makeBreadcrumbs } from '../lib/breadcrumbs';
import { breadcrumbJsonLd, pageJsonLd } from '../lib/schema';

// ScenarioLayout (Playlist)
// - Always renders the same 6 sections in a fixed order.
// - Content can come from:
//   1) Markdown body (H2 sections)
//   2) Frontmatter object `scenario`

const fm = Astro.props.frontmatter ?? Astro.props;

const {
  title = site.siteName,
  description = site.defaultDescription,
  robots = 'index,follow',
  updated = null,
  chapter = 'Szenarien',
  level = null,
  ogImage = site.defaultOgImage,
  canonical = null,
  url = null,
} = fm;

// Draft safety (same convention as DocLayout)
const statusRaw = fm.status ?? fm.provider?.status ?? null;
const status = String(statusRaw || '').trim().toLowerCase();
const isDone = !status || status === 'done';
const robotsFinal = isDone ? robots : 'noindex,follow';

// Render slot once (build-time) so we can optionally extract body sections + keep NoScript safe.
const slotHtmlRaw = isDone ? await Astro.slots.render('default') : '';

// --------- Minimal helpers (no extra deps) ---------
const escapeHtml = (s) => String(s ?? '')
  .replace(/&/g, '&amp;')
  .replace(/</g, '&lt;')
  .replace(/>/g, '&gt;')
  .replace(/"/g, '&quot;')
  .replace(/'/g, '&#39;');

const stripTags = (html) => String(html ?? '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();

function toHtmlFromMarkdownish(input) {
  const raw = String(input ?? '').trim();
  if (!raw) return '';

  const lines = raw.split(/\r?\n/);
  const bullet = lines.filter((l) => /^\s*[-*]\s+/.test(l));
  const ordered = lines.filter((l) => /^\s*\d+\.\s+/.test(l));

  if (bullet.length === lines.length) {
    return `<ul class="list">${lines.map((l) => `<li>${escapeHtml(l.replace(/^\s*[-*]\s+/, ''))}</li>`).join('')}</ul>`;
  }
  if (ordered.length === lines.length) {
    return `<ol class="scenario-steps">${lines.map((l) => `<li>${escapeHtml(l.replace(/^\s*\d+\.\s+/, ''))}</li>`).join('')}</ol>`;
  }

  // Paragraphs (blank line = new paragraph)
  const paras = raw.split(/\n\s*\n/).map((p) => p.trim()).filter(Boolean);
  return paras.map((p) => `<p>${escapeHtml(p).replace(/\n/g, '<br />')}</p>`).join('');
}

function extractSectionsFromBody(html) {
  const out = {
    risk_summary: '',
    plan_a: '',
    plan_b: '',
    plan_c: '',
    emergency: '',
    tools: '',
  };

  const src = String(html ?? '');
  if (!src) return out;

  // Split by H2 headings.
  const re = /<h2\b[^>]*>[\s\S]*?<\/h2>/gi;
  const matches = [...src.matchAll(re)];
  if (!matches.length) return out;

  for (let i = 0; i < matches.length; i++) {
    const m = matches[i];
    const hStart = m.index ?? 0;
    const hEnd = hStart + m[0].length;
    const nextStart = (matches[i + 1]?.index ?? src.length);
    const headingText = stripTags(m[0]).toLowerCase();
    const body = src.slice(hEnd, nextStart).trim();

    if (!body) continue;

    if (/^risiko\b/.test(headingText)) out.risk_summary = body;
    else if (/^(30\s*[-‑]?\s*min|30\s*min\s*plan|plan\s*a)\b/.test(headingText)) out.plan_a = body;
    else if (/^(alltag|plan\s*b)\b/.test(headingText)) out.plan_b = body;
    else if (/^(hochrisiko|plan\s*c)\b/.test(headingText)) out.plan_c = body;
    else if (/^notfall\b/.test(headingText)) out.emergency = body;
    else if (/(passende\s+tools|tools)\b/.test(headingText)) out.tools = body;
  }

  return out;
}

const bodySections = extractSectionsFromBody(slotHtmlRaw);
const scenario = (fm.scenario && typeof fm.scenario === 'object') ? fm.scenario : {};

// Prefer frontmatter data, then fallback to body sections.
const riskData = scenario.risk_summary ?? bodySections.risk_summary;
const planAData = scenario.plan_a ?? bodySections.plan_a;
const planBData = scenario.plan_b ?? bodySections.plan_b;
const planCData = scenario.plan_c ?? bodySections.plan_c;
const emergencyData = scenario.emergency ?? bodySections.emergency;
const toolsData = scenario.tools ?? bodySections.tools;

function hasMeaningful(v) {
  if (Array.isArray(v)) return v.some((x) => String(x ?? '').trim());
  if (v && typeof v === 'object') return Object.keys(v).length > 0;
  return String(v ?? '').trim().length > 0;
}

function renderSimpleBlock(v) {
  if (!hasMeaningful(v)) return '';
  if (Array.isArray(v)) {
    return `<ul class="list">${v.map((x) => `<li>${escapeHtml(x)}</li>`).join('')}</ul>`;
  }
  if (typeof v === 'string') {
    // Body extraction already returns HTML; keep it.
    const looksLikeHtml = /<\w+[\s\S]*>/.test(v);
    return looksLikeHtml ? v : toHtmlFromMarkdownish(v);
  }
  return '';
}

function normalizeTools(v) {
  if (!hasMeaningful(v)) return { kind: 'none', items: [] };

  if (Array.isArray(v)) {
    const first = v[0];
    if (typeof first === 'string') {
      const items = v.map((x) => String(x ?? '').trim()).filter(Boolean);
      return { kind: 'strings', items };
    }
    if (first && typeof first === 'object') {
      const items = v
        .map((x) => ({
          label: String(x.label ?? '').trim(),
          href: String(x.href ?? '').trim(),
        }))
        .filter((x) => x.label || x.href);
      return { kind: 'objects', items };
    }
  }

  if (typeof v === 'string') {
    const looksLikeHtml = /<\w+[\s\S]*>/.test(v);
    return { kind: 'html', items: looksLikeHtml ? String(v) : toHtmlFromMarkdownish(String(v)) };
  }

  return { kind: 'none', items: [] };
}

const toolsNorm = normalizeTools(toolsData);

function renderToolsBlock(norm) {
  if (!norm || norm.kind === 'none') return '';
  if (norm.kind === 'html') return String(norm.items ?? '');
  if (norm.kind === 'strings') {
    return `<ul class="scenario-tools">${norm.items.map((t) => `<li>${escapeHtml(t)}</li>`).join('')}</ul>`;
  }
  if (norm.kind === 'objects') {
    return `<ul class="scenario-tools">${norm.items.map((t) => {
      const label = escapeHtml(t.label || t.href || 'Tool');
      const href = escapeHtml(t.href || '#');
      if (t.href) return `<li><a class="scenario-tool-link" href="${href}">${label}</a></li>`;
      return `<li>${label}</li>`;
    }).join('')}</ul>`;
  }
  return '';
}

// Reading time: reuse DocLayout heuristic (rough), based on available content.
const readingSourceText = (
  stripTags(slotHtmlRaw) + ' ' +
  [riskData, planAData, planBData, planCData, emergencyData]
    .map((x) => (Array.isArray(x) ? x.join(' ') : String(x ?? '')))
    .join(' ') +
  (toolsNorm.kind === 'strings' ? toolsNorm.items.join(' ') : '') +
  (toolsNorm.kind === 'objects' ? toolsNorm.items.map((x) => `${x.label} ${x.href}`).join(' ') : '')
).trim();

let readingLabel = 'In Arbeit';
if (isDone) {
  const words = readingSourceText ? readingSourceText.split(/\s+/).length : 0;
  const readingMinutes = Math.max(1, Math.round(words / 200));
  readingLabel = `Lesezeit: ${readingMinutes} Min.`;
}

const canonicalUrl = canonical
  ? canonical
  : (Astro.site
      ? new URL(Astro.url.pathname, Astro.site).toString()
      : new URL(Astro.url.pathname, site.baseUrl).toString());
const canonicalUrlNorm = canonicalUrl.endsWith('/') ? canonicalUrl : `${canonicalUrl}/`;



// Share cards: scenarios behave like articles.
const ogTypeFinal = isDone ? 'article' : 'website';

const crumbs = makeBreadcrumbs({
  pathname: Astro.url?.pathname || '/',
  title,
  nav,
  homeLabel: 'Start',
  homeHref: '/start/',
});

const structuredData = isDone ? [
  breadcrumbJsonLd(crumbs),
  pageJsonLd({
    schemaType: 'Article',
    title,
    description,
    url: canonicalUrlNorm,
    updated,
    ogImage,
  }),
] : null;
---

<Base
  title={title}
  description={description}
  robots={robotsFinal}
  ogType={ogTypeFinal}
  ogImage={ogImage}
  updated={updated}
  canonical={canonical}
  structuredData={structuredData}
>
  <div class="container content scenario-layout" id="content">
    <header class="page-hero">
      <Breadcrumbs title={title} />
      <h1 class="page-title">{title}</h1>
      {description ? <p class="page-sub">{description}</p> : null}
      <div class="page-meta">
        <span>{readingLabel}</span>
        {updated ? (<><span class="dot">•</span><span>Zuletzt aktualisiert: {updated}</span></>) : null}
        {chapter ? (<><span class="dot">•</span><span>{chapter}</span></>) : null}
        {(level && String(level).toLowerCase() !== 'none') ? (<><span class="dot">•</span><span>{level}</span></>) : null}
      </div>
    </header>

    {isDone ? (
      <>
        <noscript>
          <div class="callout noscript-note">
            <p><strong>JavaScript ist deaktiviert.</strong> Die automatische Pfad‑Logik (B/C) funktioniert ohne JavaScript nicht.</p>
            <p>Du kannst trotzdem alles lesen: öffne <em>Pfad B</em> / <em>Pfad C</em> einfach manuell über die Aufklappfelder.</p>
          </div>
        </noscript>

        <nav class="scenario-playlist" aria-label="Playlist">
          <a class="playlist-link" href="#scenario-risiko">Risiko</a>
          <a class="playlist-link" href="#scenario-plan-a">30‑Min‑Plan (A)</a>
          <a class="playlist-link" href="#scenario-plan-b">Alltag (B)</a>
          <a class="playlist-link" href="#scenario-plan-c">Hochrisiko (C)</a>
          <a class="playlist-link" href="#scenario-notfall">Notfall</a>
          <a class="playlist-link" href="#scenario-tools">passende Tools</a>
        </nav>

        {hasPfade ? (
          <div class="pfad-sticky" data-pfad-sticky>
            <div class="pfad-bar" data-pfad-toggle aria-label="Pfad auswählen">
              <div class="pfad-left">
                <span class="pfad-label" aria-hidden="true">Pfad</span>
                <div class="pfad-seg" role="radiogroup" aria-label="Wie weit willst du gehen?">
                  <label class="pfad-opt" title="Pfad A: Standard (30 Minuten)">
                    <input type="radio" name="pfad" value="A" />
                    <span>A</span>
                  </label>
                  <label class="pfad-opt" title="Pfad B: Alltag (mehr Praxis)">
                    <input type="radio" name="pfad" value="B" />
                    <span>B</span>
                  </label>
                  <label class="pfad-opt" title="Pfad C: High-Risk (maximal)">
                    <input type="radio" name="pfad" value="C" />
                    <span>C</span>
                  </label>
                </div>
              </div>
              <div class="pfad-hint" aria-hidden="true">
                <span><strong>A</strong> Standard</span>
                <span class="dot">•</span>
                <span><strong>B</strong> Alltag</span>
                <span class="dot">•</span>
                <span><strong>C</strong> High-Risk</span>
                <span class="dot">•</span>
                <span class="pfad-note">B/C öffnet Details</span>
              </div>
            </div>
          </div>
        ) : null}

        <article class="article">
          <div class="article-body markdown">
            <!-- 1) Risiko -->
            <section class="scenario-section" aria-labelledby="scenario-risiko">
              <h2 id="scenario-risiko">Risiko</h2>
              <div class="scenario-section-body" set:html={riskHtml || placeholder} />
            </section>

            <!-- 2) 30-Min-Plan (A) -->
            <section class="scenario-section" aria-labelledby="scenario-plan-a">
              <h2 id="scenario-plan-a">30‑Min‑Plan <span class="pill" aria-label="Pfad A">A</span></h2>
              <div class="scenario-section-body" set:html={planAHtml || placeholder} />
            </section>

            <!-- 3) Alltag (B) -->
            <section class="scenario-section" aria-labelledby="scenario-plan-b">
              <h2 id="scenario-plan-b">Alltag <span class="pill" aria-label="Pfad B">B</span></h2>
              <details class="scenario-details" data-scenario="B">
                <summary>Pfad B: Alltag</summary>
                <div class="scenario-section-body" set:html={planBHtml || placeholder} />
              </details>
            </section>

            <!-- 4) Hochrisiko (C) -->
            <section class="scenario-section" aria-labelledby="scenario-plan-c">
              <h2 id="scenario-plan-c">Hochrisiko <span class="pill" aria-label="Pfad C">C</span></h2>
              <details class="scenario-details" data-scenario="C">
                <summary>Pfad C: Hochrisiko</summary>
                <div class="scenario-section-body" set:html={planCHtml || placeholder} />
              </details>
            </section>

            <!-- 5) Notfall -->
            <section class="scenario-section" aria-labelledby="scenario-notfall">
              <h2 id="scenario-notfall">Notfall</h2>
              <div class="scenario-section-body" set:html={emergencyHtml || placeholder} />
            </section>

            <!-- 6) passende Tools -->
            <section class="scenario-section" aria-labelledby="scenario-tools">
              <h2 id="scenario-tools">passende Tools</h2>
              <div class="scenario-section-body" set:html={toolsHtml || placeholder} />
            </section>
          </div>
        </article>

        <EeatBox
          updated={updated}
          isAnbieter={false}
          scope={chapter ? `Kapitel: ${chapter}` : 'Szenario'}
        />
      </>
    ) : (
      <article class="article">
        <div class="article-body markdown">
          <div class="callout">
            <p><strong>Hinweis:</strong> Diese Seite ist derzeit <strong>{status === 'archived' ? 'archiviert' : 'in Arbeit'}</strong> und wird bewusst nicht indexiert.</p>
            <p>Nutze solange die Suche oben oder die Kapitel‑Übersichten.</p>
          </div>
        </div>
      </article>
    )}
  </div>
</Base>
